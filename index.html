<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Service Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #fff8f0;
      font-family: 'Poppins', sans-serif;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    .logo {
      display: block;
      margin: 0 auto 10px;
      width: 120px;
    }
    .title {
      font-family: 'Playfair Display', serif;
      text-align: center;
      font-size: 28px;
      color: #6b3210;
      margin-bottom: 20px;
    }
    .input-group {
      position: relative;
      margin-bottom: 20px;
    }
    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fdf8f4;
      font-size: 14px;
    }
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-color: #fdf8f4;
    }
    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: #6b3210;
    }
    .input-group label {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #fff8f0;
      padding: 0 4px;
      color: #6b3210;
      transition: 0.2s ease;
      pointer-events: none;
    }
    .input-group input:not(:placeholder-shown) + label,
    .input-group select:valid + label,
    .input-group textarea:not(:placeholder-shown) + label,
    .input-group input:focus + label,
    .input-group textarea:focus + label,
    .input-group select:focus + label {
      top: -8px;
      left: 10px;
      font-size: 11px;
      background: #fff8f0;
    }
    .required {
      color: red;
    }
    #categoryButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .category-group {
      position: relative;
    }
    .category-group button {
      background-color: #a0522d;
      color: white;
      border: none;
      padding: 10px 18px;
      cursor: pointer;
      font-weight: 600;
      border-radius: 6px;
      font-size: 14px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
      min-width: 130px;
    }
    .category-group button:hover {
      background-color: #7a3f1d;
    }
    .service-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: white;
      border: 1px solid #ccc;
      width: 160px;
      max-height: 180px;
      overflow-y: auto;
      display: none;
      padding: 0;
      margin: 0;
      list-style: none;
      z-index: 1000;
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.15);
      border-radius: 6px;
      font-size: 13px;
    }
    .service-dropdown li {
      padding: 10px 14px;
      cursor: pointer;
    }
    .service-dropdown li:hover {
      background-color: #f0e6dc;
    }
    #servicePreview {
      margin-top: 15px;
      max-width: 100%;
      position: relative;
    }
    #selectedServiceDisplay {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 2px solid #a0522d;
      border-radius: 6px;
      background-color: #fff8f0;
      font-weight: 600;
      color: #5a2e0f;
      cursor: default;
      box-sizing: border-box;
    }
    button[type=submit] {
      display: block;
      margin: 20px auto 0;
      background: #6b3210;
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button[type=submit]:hover {
      background: #4d230a;
    }
    .ticket-display {
      text-align: center;
      margin-top: 20px;
      font-size: 16px;
      color: green;
    }
    .phone-group {
      position: relative;
    }
    .phone-group .iti {
      width: 100%;
    }
    .phone-group input {
      width: 100% !important;
      box-sizing: border-box;
      padding-left: 88px !important;
      padding-right: 40px !important;
      font-size: 16px !important;
    }
    @media (max-width: 600px) {
      .container {
        width: 100%;
        margin: 0;
        padding: 15px;
        border-radius: 0;
      }
      .input-group input,
      .input-group textarea,
      .input-group select {
        width: 100%;
        padding: 15px;
        font-size: 16px;
      }
      .category-group button {
        width: 100%;
      }
      .service-dropdown {
        position: static;
        width: 100% !important;
      }
      button[type="submit"] {
        width: 100%;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
</head>
<body>
  <div class="container">
    <img src="rfm-logo-new.svg" class="logo" alt="Logo">
    <h1 class="title">Create Ticket</h1>

    <form id="complaintForm" novalidate>
      <div class="input-group">
        <input type="text" id="name" name="name" placeholder=" " required>
        <label for="name">Name *</label>
      </div>
      <div class="input-group">
        <select id="buildingInput" name="building" required >
          <option value="" disabled selected>Select Building</option>
          <option>A Tower</option>
          <option>Aamna Residency</option>
          <option>Centurion Star</option>
          <option>Dunes Residency</option>
          <option>Grace Residency</option>
          <option>Jashn Mall</option>
          <option>Lynx Tower</option>
          <option>Mirdif Tulip</option>
          <option>Magrabi</option>
          <option>Modulex Tower</option>
          <option>Niloofar Tower</option>
          <option>Palace Tower</option>
          <option>Park Corner</option>
          <option>Opal Towers</option>
          <option>Riah Towers</option>
          <option>Silver Lining</option>
          <option>The Royal Atlantis</option>
          <option>South Residence</option>
          <option>UIC</option>
        </select>
        <label for="buildingInput">Building *</label>
      </div>

      <div id="categoryButtons">
        <div class="category-group">
          <button type="button" onclick="showDropdown('hvac', this)">‚öôÔ∏è HVAC/Mechanical</button>
          <ul class="service-dropdown"></ul>
        </div>
        <div class="category-group">
          <button type="button" onclick="showDropdown('plumbing', this)">üö∞ Plumbing</button>
          <ul class="service-dropdown"></ul>
        </div>
        <div class="category-group">
          <button type="button" onclick="showDropdown('civil', this)">üèóÔ∏è Civil</button>
          <ul class="service-dropdown"></ul>
        </div>
        <div class="category-group">
          <button type="button" onclick="showDropdown('electrical', this)">‚ö° Electrical</button>
          <ul class="service-dropdown"></ul>
        </div>
        <div class="category-group">
          <button type="button" onclick="showDropdown('others', this)">üõ†Ô∏è Others</button>
          <ul class="service-dropdown"></ul>
        </div>
      </div>

      <div class="input-group" id="servicePreview" style="display: none;">
        <input type="text" id="selectedServiceDisplay" name="issueType" readonly required>
        <label for="selectedServiceDisplay">‚úÖ Selected Service <span class="required">*</span></label>
      </div>

      <div class="input-group">
        <input type="email" id="email" name="email" placeholder=" " required>
        <label for="email">Email ID *</label>
      </div>
      <div class="input-group phone-group">
        <input type="tel" id="phone" name="phone" placeholder=" " required>
        <label for="phone"></label>
      </div>
      <div class="input-group">
        <input type="date" id="date" name="date" required>
        <label for="date">Date of Request*</label>
      </div>
      <div class="input-group">
        <input type="text" id="subject" name="subject" placeholder=" " required>
        <label for="subject">Subject *</label>
      </div>
      <div class="input-group">
        <textarea id="description" name="description" rows="4" placeholder=" " required></textarea>
        <label for="description">Description *</label>
      </div>

      <label for="images">üìé Upload Images</label>
      <input type="file" id="images" name="images" multiple accept="image/*">

      <button type="submit">Submit</button>
    </form>

    <div id="ticketNumber" class="ticket-display"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAFDtHYbnlbqvvmTYeMDnWIxRseC2w_m9M",
      authDomain: "maintenance-portal-e548a.firebaseapp.com",
      projectId: "maintenance-portal-e548a",
      storageBucket: "maintenance-portal-e548a.firebasestorage.app",
      messagingSenderId: "1069146220780",
      appId: "1:1069146220780:web:340b2a816ff5f412d31dc9"
    };
    firebase.initializeApp(firebaseConfig);
    

    (function(){
      emailjs.init({ publicKey: "kJxrSST4XRt1LLztu" });
    })();

    let iti;
    try {
      const phoneInput = document.getElementById('phone');
      iti = intlTelInput(phoneInput, {
        separateDialCode: true,
        preferredCountries: ['ae', 'in', 'gb', 'qa'],
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
      });
    } catch (error) {
      console.error('Phone input initialization error:', error);
      alert('Failed to initialize phone input. Please refresh.');
    }

    const serviceOptions = {
      hvac: ['AC Not Cooling', 'AC Leakage', 'AC Water Leak', 'AC Electrical Trip', 'Thermostat not working', 'AC Noise Issue', 'CHW pipe leak', 'AC Air flow Issue', 'Gas Leakage', 'Kitchen Exhaust Issue'],
      plumbing: ['Leaking Tap', 'Drain Blocked', 'Low Pressure', 'Sanitary Wear Broken', 'Wall Leakage', 'Water Supply Interruption', 'Washroom Accessories', 'Odour', 'Major Leakage', 'Geyser Leakage'],
      civil: ['Joinery-(Table, Chair, Door, Cupboard)', 'Carpentry- (Gypsum Ceiling, Walls)', 'Masonry- (Broken Tile, Crack Filling)', 'Paint', 'Sloping Issue in Toilets', 'Marbles and Tiles'],
      electrical: ['Power Trip', 'Light and Bulb Fuse', 'Power socket Issue', 'Short Circuit', 'Appliances not working', 'Broken trip issue', 'Telephones and Data'],
      others: ['LV Systems', 'Building Management Systems', 'Security Equipment Barrier Blockers', 'CCTV Systems', 'Waste Management', 'Pest Control', 'Facade Cleaning', 'Cleaning & House Keeping Services', 'Gardening & Landscaping', 'Health Club & Swimming Pool Management', 'Water Tank cleaning', 'Re- Modeling', 'Renovation', 'Interior Designs', 'Fit out', 'Smart Home Solutions', 'Green Building Solution', 'Other']
    };

    function showDropdown(category, btn) {
      document.querySelectorAll('.service-dropdown').forEach(drop => drop.style.display = 'none');
      const dropdown = btn.nextElementSibling;
      dropdown.innerHTML = '';
      serviceOptions[category].forEach(service => {
        const li = document.createElement('li');
        li.textContent = service;
        li.onclick = () => {
          document.getElementById('selectedServiceDisplay').value = service;
          document.getElementById('servicePreview').style.display = 'block';
          dropdown.style.display = 'none';
        };
        dropdown.appendChild(li);
      });
      dropdown.style.display = 'block';
    }

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.category-group')) {
        document.querySelectorAll('.service-dropdown').forEach(drop => drop.style.display = 'none');
      }
    });

    document.getElementById('complaintForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const serviceInput = document.getElementById('selectedServiceDisplay');
      const ticketNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const adminURL = `http://localhost:5502/manager.html?name=${encodeURIComponent(form.name.value.trim())}&phone=${encodeURIComponent(iti.getNumber())}&building=${encodeURIComponent(form.building.value.trim())}&service=${encodeURIComponent(serviceInput.value.trim())}&ticket=${ticketNumber}&client_email=${encodeURIComponent(form.email.value.trim())}&workdesc=${encodeURIComponent(form.description.value.trim())}`;

;

      const requestData = {
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        phone: iti.getNumber(),
        building: form.building.value.trim(),
        service: serviceInput.value.trim(),
        date: form.date.value,
        subject: form.subject.value.trim(),
        description: form.description.value.trim(),
        ticket_number: ticketNumber,
        technician_link: adminURL
      };
      const dbRef = firebase.database().ref('service_requests');

try {
  await dbRef.child(requestData.ticket_number).set(requestData);
  console.log("Data saved to Firebase successfully.");
} catch (error) {
  console.error("Error saving to Firebase:", error);
  alert("Failed to save data to database.");
}


      if (!requestData.name || !requestData.email || !requestData.phone || !requestData.building || !requestData.service || !requestData.date) {
        alert('Please fill all required fields!');
        return;
      }

      try {
        const trackingURL = `http://localhost:5501/track.html`;

await emailjs.send('service_c7lpetl', 'template_mzjg36v', {
  to_email: requestData.email,
  reply_to: requestData.email,
  name: requestData.name,
  building: requestData.building,
  service: requestData.service,
  email: requestData.email,
  phone: requestData.phone,
  date: requestData.date,
  subject: requestData.subject,
  description: requestData.description,
  ticket_number: requestData.ticket_number,
  tracking_link: trackingURL
});


        await emailjs.send('service_c7lpetl', 'template_09dm767', {
          to_email: 'reliancemaintenance8@gmail.com',
          reply_to: requestData.email,
          client_name: requestData.name,
          client_email: requestData.email,
          client_contact: requestData.phone,
          building_name: requestData.building_name,
          service: requestData.service,
          request_date: requestData.date,
          ticket_number: requestData.ticket_number,
          workdesc: requestData.description,
          technician_link: adminURL,
          message_html: `
            <h3>üîî New Service Request Received</h3>
            <p><strong>Client Name:</strong> ${requestData.name}</p>
            <p><strong>Email:</strong> ${requestData.email}</p>
            <p><strong>Phone:</strong> ${requestData.phone}</p>
            <p><strong>Building:</strong> ${requestData.building}</p>
            <p><strong>Service:</strong> ${requestData.service}</p>
            <p><strong>Date:</strong> ${requestData.date}</p>
            <p><strong>Ticket #:</strong> ${requestData.ticket_number}</p>
            <p><strong>Description:</strong> ${requestData.description}</p>
            <p><strong>Manager Portal:</strong> <a href="${adminURL}">Click Here</a></p>
          `
        });

        document.getElementById('ticketNumber').innerHTML = `
          <p style="color:green;font-weight:bold;">
            ‚úÖ Ticket #${requestData.ticket_number} created successfully!
          </p>
          <p>Confirmation sent to ${requestData.email}</p>
          <p>Maintenance team notified with all details</p>
        `;

        form.reset();
        document.getElementById('servicePreview').style.display = 'none';
      } catch (error) {
        console.error('Email failed:', error);
        alert('Failed to submit. Please check console for details.');
      }
    });
  </script>
  
</body>
</html>
