<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Technician Portal</title>
  <style>
    /* Color Scheme */
    :root {
        --maroon: #800000;
        --dark-maroon: #5a0000;
        --light-maroon: #a04545;
        --beige: #f5f5dc;
        --light-gray: #f8f9fa;
        --white: #ffffff;
        --dark-text: #333333;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--beige);
        color: var(--dark-text);
    }

    /* Company Header */
    .company-header {
        background-color: var(--white);
        padding: 15px 0;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .company-logo {
        height: 70px;
        width: auto;
        max-width: 300px;
    }

    .container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
        text-align: center;
        color: var(--maroon);
        margin-bottom: 30px;
    }

    .client-display {
        background-color: var(--maroon);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .client-display h2 {
        margin: 0;
        color: white;
    }

    .ticket-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .info-box {
        background-color: var(--light-gray);
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid var(--maroon);
    }

    .info-box h3 {
        margin-top: 0;
        color: var(--maroon);
    }

    .service-options, .feedback-options {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 8px;
    }

    .service-options label, .feedback-options label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        white-space: nowrap;
    }

    .work-description {
        margin-bottom: 30px;
    }

    .work-description h2 {
        color: var(--maroon);
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .action-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .upload-section, .timer-section, .signature-section, 
    .customer-feedback, .technician-remarks {
        background-color: var(--light-gray);
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .upload-section h2, .timer-section h2, .signature-section h2, 
    .customer-feedback h2, .technician-remarks h2 {
        margin-top: 0;
        color: var(--maroon);
    }

    .upload-btn {
        display: inline-block;
        padding: 10px 15px;
        background-color: var(--maroon);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 0;
    }

    .upload-btn:hover {
        background-color: var(--dark-maroon);
    }

    .timer-section {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .timer-display {
        font-size: 24px;
        text-align: center;
        margin: 15px 0;
        font-family: monospace;
        width: 100%;
    }

    .time-records {
        margin: 10px 0;
        font-size: 14px;
        color: var(--dark-text);
    }

    .time-records p {
        margin: 5px 0;
    }

    .timer-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .timer-btn {
        padding: 10px 15px;
        background-color: var(--maroon);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        min-width: 150px;
    }

    .timer-btn.stop {
        background-color: var(--light-maroon);
    }

    .timer-btn:hover {
        opacity: 0.9;
    }

    .signature-pad {
        width: 100%;
        height: 150px;
        border: 1px solid #ddd;
        background-color: white;
        margin-bottom: 10px;
    }

    .clear-btn {
        padding: 8px 12px;
        background-color: #95a5a6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .submit-btn {
        display: block;
        width: 100%;
        padding: 15px;
        background-color: var(--maroon);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 30px;
    }

    .submit-btn:hover {
        background-color: var(--dark-maroon);
    }

    .print-btn {
        display: none;
        width: 100%;
        padding: 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 10px;
    }

    .print-btn:hover {
        background-color: #2980b9;
    }

    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .preview-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .customer-feedback textarea,
    .technician-remarks textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        resize: vertical;
        margin-top: 10px;
    }

    .customer-feedback textarea:focus,
    .technician-remarks textarea:focus {
        outline: none;
        border-color: var(--maroon);
        box-shadow: 0 0 0 2px rgba(128, 0, 0, 0.2);
    }

    @media print {
        .company-header, .submit-btn, .print-btn, .upload-btn, 
        .timer-btn, .clear-btn, input, textarea {
            display: none !important;
        }

        .container {
            box-shadow: none;
            margin: 0;
            padding: 10px;
            max-width: 100%;
        }

        .action-section {
            grid-template-columns: 1fr;
        }

        .preview-images {
            justify-content: center;
        }

        .preview-image {
            width: 200px;
            height: 200px;
        }

        .signature-pad {
            border: 1px solid #000;
        }
    }

    @media (max-width: 768px) {
        .ticket-info, .action-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 600px) {
        .service-options, .feedback-options {
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }
    }
  </style>
</head>
<body>
  <header class="company-header">
    <img src="rfm-logo-new.svg" alt="Company Logo" class="company-logo" />
  </header>

  <div class="container" id="content-to-print">
    <h1>Technician Work Portal</h1>

    <div class="client-display">
      <h2>Client: <span id="client-name-display">Loading...</span></h2>
    </div>

    <div class="ticket-info">
      <div class="info-box">
        <h3>Ticket Number</h3>
        <p id="ticket-number">Loading...</p>
      </div>
      <div class="info-box">
        <h3>Client Name</h3>
        <p id="name">Loading...</p>
      </div>
      <div class="info-box">
        <h3>Phone Number</h3>
        <p id="phone">Loading...</p>
      </div>
      <div class="info-box">
        <h3>Building</h3>
        <p id="building">Loading...</p>
      </div>
      <div class="ticket-info">
  <!-- ... existing fields ... -->
  <div class="info-box">
    <h3>Client Email</h3>
    <p id="client-email">Loading...</p>
  </div>
  <!-- ... rest of your fields ... -->
</div>
      <div class="info-box">
        <h3>Service Type</h3>
        <div class="service-options">
          <label><input type="checkbox" name="service" value="AC"> AC</label>
          <label><input type="checkbox" name="service" value="Electrical"> Electrical</label>
          <label><input type="checkbox" name="service" value="Plumbing"> Plumbing</label>
          <label><input type="checkbox" name="service" value="Others"> Others</label>
        </div>
      </div>
    </div>

    <div class="work-description">
      <h2>Work Description</h2>
      <p id="work-description">Loading...</p>
    </div>

    <div class="action-section">
      <div class="upload-section">
        <h2>Upload Images</h2>
        <p>Upload before and after photos of the work</p>
        <input type="file" id="image-upload" accept="image/*" multiple style="display: none;" />
        <button class="upload-btn" id="upload-button">Select Images</button>
        <div class="preview-images" id="image-preview"></div>
      </div>

      <div class="timer-section">
        <h2>Work Timer</h2>
        <p>Track time spent on this job</p>
        <div class="timer-display" id="timer">00:00:00</div>
        <div class="time-records">
          <p>Start Time: <span id="start-time">Not started</span></p>
          <p>End Time: <span id="end-time">Not completed</span></p>
        </div>
        <div class="timer-buttons">
          <button class="timer-btn" id="start-timer" style="display:none;">Start Work</button>
          <button class="timer-btn stop" id="stop-timer">End Work</button>
        </div>
      </div>
    </div>

    <div class="technician-remarks">
      <h2>Technician's Remarks</h2>
      <textarea id="technician-remarks" placeholder="Enter any additional comments about the work..."></textarea>
    </div>

    <div class="customer-feedback">
      <h2>Customer Feedback</h2>
      <div class="feedback-options">
        <label><input type="checkbox" name="feedback" value="Excellent"> Excellent</label>
        <label><input type="checkbox" name="feedback" value="Very Good"> Very Good</label>
        <label><input type="checkbox" name="feedback" value="Good"> Good</label>
        <label><input type="checkbox" name="feedback" value="Average"> Average</label>
        <label><input type="checkbox" name="feedback" value="Poor"> Poor</label>
      </div>
      <textarea id="customer-comments" placeholder="Customer comments (optional)"></textarea>
    </div>

    <div class="signature-section">
      <h2>Customer Approval</h2>
      <p>Have the customer sign below to confirm work completion</p>
      <canvas class="signature-pad" id="signature-pad"></canvas>
      <button class="clear-btn" id="clear-signature">Clear Signature</button>
    </div>

    <button class="submit-btn" id="submit-work">Submit Work Completion</button>
    <button class="print-btn" id="print-pdf">Download PDF Report</button>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <!-- html2pdf.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyAFDtHYbnlbqvvmTYeMDnWIxRseC2w_m9M",
  authDomain: "maintenance-portal-e548a.firebaseapp.com",
  projectId: "maintenance-portal-e548a",
  storageBucket: "maintenance-portal-e548a.appspot.com",
  messagingSenderId: "1069146220780",
  appId: "1:1069146220780:web:340b2a816ff5f412d31dc9",
  databaseURL: "https://maintenance-portal-e548a-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

    // Initialize EmailJS
    emailjs.init('izcTDhhNGe6VtR2VO');

    document.addEventListener('DOMContentLoaded', function() {
      // Load ticket data from URL parameters
      const params = new URLSearchParams(window.location.search);
      const ticket = params.get("ticket_number") || "N/A";
      const name = params.get("name") || "N/A";
      const phone = params.get("phone") || "N/A";
      const workdesc = params.get("workdesc") || "N/A";
      const building = params.get("building") || "N/A";
      const service = params.get("service") || "";
      const clientEmail = params.get("client_email") || "";

      // Set DOM elements
      document.getElementById("ticket-number").textContent = ticket;
      document.getElementById("name").textContent = decodeURIComponent(name);
      document.getElementById("client-name-display").textContent = decodeURIComponent(name);
      document.getElementById("phone").textContent = phone;
      document.getElementById("building").textContent = decodeURIComponent(building);
      document.getElementById("work-description").textContent = decodeURIComponent(workdesc);
      // In your DOMContentLoaded function:
document.getElementById("client-email").textContent = clientEmail || "Not provided";

      // Check service checkbox if specified
      if (service) {
        const checkbox = document.querySelector(`input[name="service"][value="${service}"]`);
        if (checkbox) checkbox.checked = true;
      }

      // Save work info globally
      window.workInfo = {
        ticket,
        name: decodeURIComponent(name),
        phone,
        building: decodeURIComponent(building),
        workdesc: decodeURIComponent(workdesc),
        service,
        clientEmail
      };

      // Initialize signature pad
      const canvas = document.getElementById('signature-pad');
      const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(0, 0, 0)'
      });

      // Clear signature button
      document.getElementById('clear-signature').addEventListener('click', () => {
        signaturePad.clear();
      });

      // Timer functionality
      let timerInterval;
      let seconds = 0;
      const timerDisplay = document.getElementById('timer');
      const startTimerBtn = document.getElementById('start-timer');
      const stopTimerBtn = document.getElementById('stop-timer');
      let startTime = null;
      let endTime = null;
      const printPdfBtn = document.getElementById('print-pdf');
      
      // Initially hide the PDF button
      printPdfBtn.style.display = 'none';

      function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }

      function getCurrentDateTimeString() {
        const now = new Date();
        return now.toLocaleString();
      }

      // Start timer automatically
      function startTimer() {
        startTimerBtn.disabled = true;
        stopTimerBtn.disabled = false;
        startTime = getCurrentDateTimeString();
        document.getElementById('start-time').textContent = startTime;
        document.getElementById('end-time').textContent = "In progress...";
        timerInterval = setInterval(() => {
          seconds++;
          timerDisplay.textContent = formatTime(seconds);
        }, 1000);
      }
      
      // Start timer immediately when page loads
      startTimer();

      // Stop timer button
      stopTimerBtn.addEventListener('click', () => {
        clearInterval(timerInterval);
        startTimerBtn.disabled = false;
        stopTimerBtn.disabled = true;
        endTime = getCurrentDateTimeString();
        document.getElementById('end-time').textContent = endTime;
      });

      // Image upload functionality
      const imageUpload = document.getElementById('image-upload');
      const imagePreview = document.getElementById('image-preview');
      const uploadButton = document.getElementById('upload-button');

      uploadButton.addEventListener('click', () => {
        imageUpload.click();
      });

      imageUpload.addEventListener('change', (event) => {
        imagePreview.innerHTML = '';
        const files = event.target.files;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.match('image.*')) continue;

          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-image');
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });

      // Form submission (only sends to client)
      document.getElementById('submit-work').addEventListener('click', async () => {
        try {
          // Validate signature
          if (signaturePad.isEmpty()) {
            alert('Please have the customer provide a signature.');
            return;
          }

          // Stop timer if running
          if (timerInterval) {
            clearInterval(timerInterval);
            endTime = getCurrentDateTimeString();
            document.getElementById('end-time').textContent = endTime;
          }
          

          // Get form data
          const services = Array.from(document.querySelectorAll('input[name="service"]:checked'))
                            .map(cb => cb.value).join(', ') || 'Not specified';
          const feedback = Array.from(document.querySelectorAll('input[name="feedback"]:checked'))
                            .map(cb => cb.value).join(', ') || 'No feedback provided';
          const technicianRemarks = document.getElementById('technician-remarks').value;
          const customerComments = document.getElementById('customer-comments').value;
          const signatureImage = signaturePad.toDataURL();

          // Client email parameters (matches client template)
          const clientEmailParams = {
            to_email: window.workInfo.clientEmail,
            to_name: window.workInfo.name,
            ticket_number: window.workInfo.ticket,
            service: services,
            time_spent: formatTime(seconds),
            work_description: window.workInfo.workdesc,
            technician_remarks: technicianRemarks,
            customer_feedback: feedback,
            customer_comments: customerComments,
            signature_image: signatureImage,
            date_time: getCurrentDateTimeString()
          };

          // Show loading state
          const submitBtn = document.getElementById('submit-work');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';

          // Send email only to client if email exists
          if (window.workInfo.clientEmail) {
            await emailjs.send('service_2zga91s', 'template_apa3uz7', clientEmailParams);
            console.log('Client email sent');
            
            // Show success and enable PDF download
            alert('Work submitted successfully! Email has been sent to client.');
            document.getElementById('print-pdf').style.display = 'block';
document.getElementById('print-pdf').addEventListener('click', downloadReport);

          } else {
            alert('Work submitted successfully! No client email was provided.');
            document.getElementById('print-pdf').style.display = 'block';
          }
const ticketKey = window.workInfo.ticket;
function downloadReport() {
  const baseReportURL = "http://localhost:5502/report.html"; // ✅ Use your deployed URL in production

  const params = new URLSearchParams();
  params.set("ticket_number", window.workInfo.ticket);
  params.set("name", window.workInfo.name);
  params.set("phone", window.workInfo.phone);
  params.set("building", window.workInfo.building);
  params.set("service", window.workInfo.service);
  params.set("workdesc", window.workInfo.workdesc);
  params.set("client_email", window.workInfo.clientEmail);

  // Additional from DOM
  params.set("technician_remarks", document.getElementById("technician-remarks").value);
  params.set("customer_feedback", Array.from(document.querySelectorAll('input[name="feedback"]:checked')).map(cb => cb.value).join(', '));
  params.set("customer_comments", document.getElementById("customer-comments").value);
  params.set("start_time", document.getElementById("start-time").textContent);
  params.set("end_time", document.getElementById("end-time").textContent);
  params.set("time_spent", document.getElementById("timer").textContent);

  // Open the report page in a new tab with all parameters
  const fullURL = `${baseReportURL}?${params.toString()}`;
  window.open(fullURL, "_blank");
}


db.ref("service_requests/" + ticketKey).update({
  status: "done",
  technicianRemarks: technicianRemarks,
  customerFeedback: feedback,
  customerComments: customerComments,
  timeSpent: formatTime(seconds),
  workCompletionTime: getCurrentDateTimeString()
}).then(() => {
  console.log("Status updated to done in Firebase");
}).catch((error) => {
  console.error("Error updating status:", error);
});

        } catch (error) {
          console.error('Submission error:', error);
          alert(`Submission failed: ${error.message}\nCheck console for details.`);
        } finally {
          const submitBtn = document.getElementById('submit-work');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Work Completion';
        }
      });

      // PDF Generation
      printPdfBtn.addEventListener('click', function(e) {
        e.preventDefault();
        generatePDF();
      });

      function generatePDF() {
        const element = document.getElementById('content-to-print');
        const opt = {
          margin: 10,
          filename: `work_report_${document.getElementById('ticket-number').textContent}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true
          },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
      }

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear();
      }

      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();
    });
  </script>
</body>
</html>